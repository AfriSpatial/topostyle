Open styling for South African National Maps

Copyright 2013 AfriSpatial

Starting with 1:50000 topographical maps

Aim: A free, public set of styles that will enable anyone to publish the free data available from NGI (http://www.ngi.gov.za) as a web or desktop map that looks exactly like the 1:50000 topographical map sheets. Hopefully this will also be endorsed, used and contributed to by NGI. 

Admire Nyakudya and Gavin Fleming from AfriSpatial have invested in getting the map and styles to the point where we feel confident to share it. We hope you find these useful. 

Objective: Style the web maps to look as close as possible to the familiar topo map sheets in the following context:

1) all styles to be defined in OGC SLD (Styled Layer Descriptor)
2) custom graphics in SVG or png formats
3) conform to NGI published specifications where available. Docs in the 'specs' folder specify almost everything except layer order.
4) Look 'perfect' at and around 1:50000. Then extend to scale and generalise at smaller scales.  

See the styles in action:

1Map is kindly hosting an instance of the NGI data, managed by AfriSpatial.

1) Register with http://1map.co.za
2) Find or browse to somewhere in South Africa
3) Zoom to 1:64000 or closer
4) switch on the 1Map/base/NGI layer
5) optionally, change the base layer to 'None'

You will see the current version of the map, not necessarily with the latest styles or layer order (because it is cached for speed).

The 'NGI' layer on 1Map

This is a 'group layer' consisting of nearly forty separately-styled WMS layers. 

The aim is to improve each individual layer style and the way they interact in the group (layer order, transparency) to perfect the map.


Working with the map and testing style changes

The idea is to edit the styles to improve them. Once they represent an improvement you are satisfied with, you commit to github or make a pull request, depending on your commit rights. 

1) If you have the four-DVD set of shapefiles from NGI (free public data), you can use the resources available here to load them all into PostGIS (http://postgis.refractions.net) and publish and style them. You can do this on your own computer, or a server on your LAN / Internet / Cloud.

a) load the shapefiles into PostGIS (see scripts in this repo). This will add the data from every single shapefile in every single map sheet into one country-wide layer per feature type.  
b) publish via your own instance of GeoServer or any other web map server that can use SLD styles OR open the PostGIS layers in a desktop GIS like QGIS or uDIG and apply and edit the styles there. 

The layer names, field names and class values that we use map to or match those of the NGI data. For a list of map layers, just see the names of the SLD files. They match the database table names AND the WMS layer names. Where the SLD has a number such as 'airtransportarea2.sld', it still refers to the database table "airtransportarea" but indicates that it has been published as more than one layer, each rendering different feature classes. 

The scripts do a few bulk data cleanups, such as dropping unnecessary fields and merging tables representing the same feature types.  

Some layers are repeated / split in the styling where we deemed necessary.

We have refrained from any data editing. As long as NGI keeps the same format, you should be able to load their next releases without breaking the map.

2) If you don't have the data or hardware, you can still work on the styles and see the effects of your edits and improvements. 

a) make WMS GetMap http POST requests against the 1Map GeoServer WMS service, specifying your SLDs. This will override the styles on the server for that request only. General details for how to do that are explained here: http://geo-solutions.blogspot.com/2012/04/dynamic-wms-styling-with-geoserver-sld.html. You can request one or more layers or even all the layers representing the whole map and manipulate individual layers and layer order. 


Examples:

(to come...or please add!)

http://www.1map.co.za/apps/onemap2?method=maptile&type=GWC&layerid=144&url=http://localhost/geoserver/gwc/service/wms&LAYERS=afrispatial%3ANGI&FORMAT=image%2Fpng8&TRANSPARENT=true&FORMAT_OPTIONS=&TILELOADINGDELAY=0&TILESORIGIN=-20037508.34%2C-20037508.34&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&SRS=EPSG%3A900913&BBOX=3248267.9567958,-3350999.3172331,3253159.9266061,-3346107.3474228&WIDTH=256&HEIGHT=256


Manipulating layers and Styles via the GeoServer REST API

Note: you need to authenticate with admin rights to do this. We would make requests like this once an improved style is committed and we want to update the live map permanently. 

publishing a layer
curl -v -u username:password -X POST -H "Content-type: text/xml" -d "<featureType><name>airtransportarea</name></featureType>" http://1map.co.za/geoserver/rest/workspaces/quidity/datastores/ngi/featuretypes


in order to create a style using rest API

curl -v -u username:password -XPOST -H "Content-type: text/xml"  -d "<style><name>islandarea</name><filename>islandarea.sld</filename></style>"  http://1map.co.za/geoserver/rest/styles

--in order to populate an empty style with a style

curl -v -u username:password -XPUT -H "Content-type: application/vnd.ogc.sld+xml" -d @/home/admire/Documents/workingfiles/ngi/ngistyles_sld/islandarea.sld http://1map.co.za:8080/geoserver/rest/styles/islandarea

--in order to associate a style with a layer

curl -v -u username:password -XPUT -H "Content-type: text/xml"  -d "<layer><defaultStyle><name>islandarea</name></defaultStyle><enabled>true</enabled></layer>" http://1map.co.za:8080/geoserver/rest/layers/quidity:islandarea

--creating a layer group

first create a xml document and then using rest api

curl -u username:password -XPOST -d @/home/admire/Documents/workingfiles/ngi/ngistyles_sld/ngLayerGroup.xml -H 'Content-type: text/xml' http://1map.co.za:8080/geoserver/rest/layergroups








